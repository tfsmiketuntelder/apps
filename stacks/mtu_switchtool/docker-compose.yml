version: "3.9"

services:
  db:
    image: postgres@sha256:5ec39c188013123927f30a006987c6b0e20f3ef2b54b140dfa96dac6844d883f
    container_name: mtu_switchtool_db
    restart: always
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - database:/var/lib/postgresql
    networks:
      - mtu_switchtool-network
      - pg_backup
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      retries: 5

  frontend:
    image: ghcr.io/myrenic/switchreporttool:frontend-latest
    restart: unless-stopped
    environment:
      NODE_ENV: production
      VITE_REACT_APP_DATABASE_API_URL: ${VITE_REACT_APP_DATABASE_API_URL}
      VITE_REACT_APP_CISCO_API_URL: ${VITE_REACT_APP_CISCO_API_URL}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOCKER_SERVER_NAME}`) && PathPrefix(`/mtu`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    networks:
      - mtu_switchtool-network
      - external
    depends_on:
      - backend-db
      - backend-cisco

  backend-cisco:
    image: ghcr.io/myrenic/switchreporttool:backend-cisco-latest  
    restart: unless-stopped
    environment:
      API_TO_DB: http://backend-db:5000
      HOST_USERNAME: ${HOST_USERNAME}
      HOST_PASSWORD: ${HOST_PASSWORD}
      API_PASSWORD: ${CISCO_API_PASSWORD}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-cisco.rule=Host(`${DOCKER_SERVER_NAME}`) && PathPrefix(`/api/cisco`)"
      - "traefik.http.routers.backend-cisco.entrypoints=websecure"
      - "traefik.http.services.backend-cisco.loadbalancer.server.port=5001"
    networks:
      - mtu_switchtool-network
      - external

  backend-db:
    image: ghcr.io/myrenic/switchreporttool:backend-db-latest  
    restart: unless-stopped
    environment:
      DB_PASSWORD: ${DB_PASSWORD}
      DB_HOST: mtu_switchtool_db
      DB_PORT: 5432
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-db.rule=Host(`${DOCKER_SERVER_NAME}`) && PathPrefix(`/api/db`)"
      - "traefik.http.routers.backend-db.entrypoints=websecure"
      - "traefik.http.services.backend-db.loadbalancer.server.port=5000"
    networks:
      - mtu_switchtool-network
      - external

volumes:
  database:

networks:
  mtu_switchtool-network:
    driver: bridge
  external:
    external: true
  pg_backup:
    external: true